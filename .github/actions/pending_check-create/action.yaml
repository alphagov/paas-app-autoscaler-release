name: 'Check-Job-Creation'
description: 'Creates a github-actions check-job'
inputs:
  github_token:
    description: "GitHub-token to access the repository"
    required: true
outputs:
  check_id:
    description: "ID of the created check"
    value: ${{ steps.create_check.outputs.check_id }}
runs:
  using: 'composite'
  steps:
  - name: Adding initial pending acceptance test check
    id: create_check
    shell: bash
    env:
      ACT_RUN: 'if [ "${ACT}" ] && [ "${ACT_OVERRIDE:-"false"}" == "false" ]; then echo "NOTICE: step is running via ACT - skipping"; exit 0; fi;'
      PR_SHA: "${{github.event.pull_request.head.sha}}"
      GH_RUN_ID: "${{ github.run_id }}"
      github_token: ${{ github.token }}
      github_repository: ${{ github.repository}}
    run: |
      # Checking run under ACT with override option
      eval "${ACT_RUN}"

      echo '::group::Creating new check'
      curl -vf -POST \
        --retry 5 \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: token ${github_token}" \
        "https://api.github.com/repos/${GITHUB_REPOSITORY}/check-runs" \
        -d '
          {
            "name":        "${{env.check_name}}",
            "head_sha":    "${{env.PR_SHA}}",
            "status":      "in_progress",
            "external_id": "${{env.GH_RUN_ID}}",
            "output": {
                        "title":   "Acceptance Test running",
                        "summary": "acceptance tests for commit ${{env.PR_SHA}}",
                        "text":    "Awaiting test result"
            }
          }
        ' \
        -o new_check.json

      id=$(jq -r '.id' new_check.json)

      if [ -z "${id}" ]; then
        echo "ERROR: Failed to create the required check job"
        echo "Result of curl:"
        cat new_check.json
        exit 1
      fi
      echo "::endgroup::"

      echo "Id is: ${id}"
      echo "::set-output name=check_id::${id}"

